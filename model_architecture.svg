<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 700" width="1200" height="700">
  <defs>
    <!-- Gradient for feature extractor -->
    <linearGradient id="extractorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#9e9e9e"/>
      <stop offset="100%" style="stop-color:#616161"/>
    </linearGradient>
    <!-- Gradient for support features (orange/red) -->
    <linearGradient id="supportGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ff7043"/>
      <stop offset="100%" style="stop-color:#e64a19"/>
    </linearGradient>
    <!-- Gradient for query features (blue) -->
    <linearGradient id="queryGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#42a5f5"/>
      <stop offset="100%" style="stop-color:#1565c0"/>
    </linearGradient>
    <!-- Arrow marker -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arrowheadBlue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1565c0"/>
    </marker>
    <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2e7d32"/>
    </marker>
    <marker id="arrowheadRed" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c62828"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1200" height="700" fill="#ffffff"/>

  <!-- ========== SOURCE DOMAIN (Top) ========== -->
  <!-- Source Domain Label -->
  <rect x="20" y="40" width="120" height="30" rx="5" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
  <text x="80" y="60" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#1976d2">Source Domain</text>

  <!-- Input images X1^S and X2^S -->
  <rect x="30" y="85" width="45" height="45" fill="#bbdefb" stroke="#1976d2" stroke-width="1"/>
  <text x="52" y="112" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">X₁ˢ</text>
  
  <rect x="85" y="85" width="45" height="45" fill="#bbdefb" stroke="#1976d2" stroke-width="1"/>
  <text x="107" y="112" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">X₂ˢ</text>

  <!-- Arrow from inputs to difference block -->
  <line x1="135" y1="107" x2="155" y2="107" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Get difference images block (vertical) -->
  <rect x="165" y="60" width="30" height="140" rx="3" fill="#e8f5e9" stroke="#388e3c" stroke-width="1.5"/>
  <text x="180" y="100" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#2e7d32" transform="rotate(-90, 180, 130)">Get difference images</text>

  <!-- Arrow from difference to contrastive sets -->
  <line x1="200" y1="107" x2="220" y2="107" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Contrastive Support Set (Source) -->
  <rect x="230" y="65" width="80" height="35" rx="4" fill="#fff3e0" stroke="#ef6c00" stroke-width="1.5"/>
  <text x="270" y="78" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#e65100">Contrastive</text>
  <text x="270" y="90" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#e65100">Support set</text>

  <!-- Contrastive Query Set (Source) -->
  <rect x="230" y="110" width="80" height="35" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1.5"/>
  <text x="270" y="123" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#1565c0">Contrastive</text>
  <text x="270" y="135" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#1565c0">Query set</text>

  <!-- Arrows to Feature extractor -->
  <line x1="315" y1="82" x2="345" y2="107" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="315" y1="127" x2="345" y2="107" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Feature Extractor (Source - shared) -->
  <polygon points="355,80 405,107 355,135" fill="url(#extractorGrad)" stroke="#424242" stroke-width="1.5"/>
  <text x="375" y="112" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Feature</text>
  <text x="375" y="102" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">Extractor</text>

  <!-- Arrows from Feature extractor to features -->
  <line x1="410" y1="95" x2="430" y2="82" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="410" y1="120" x2="430" y2="127" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Support Features (Source) -->
  <rect x="440" y="60" width="60" height="35" rx="3" fill="url(#supportGrad)" stroke="#bf360c" stroke-width="1"/>
  <text x="470" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Support</text>
  <text x="470" y="92" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">features</text>

  <!-- Query Features (Source) -->
  <rect x="440" y="105" width="60" height="35" rx="3" fill="url(#queryGrad)" stroke="#0d47a1" stroke-width="1"/>
  <text x="470" y="127" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Query</text>
  <text x="470" y="137" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">features</text>

  <!-- Arrow to INSCL-S -->
  <line x1="505" y1="95" x2="535" y2="95" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- INSCL-S Block -->
  <rect x="545" y="45" width="140" height="120" rx="5" fill="#fce4ec" stroke="#c2185b" stroke-width="2"/>
  <text x="615" y="62" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#880e4f">INSCL-S</text>
  
  <!-- Changed features (purple circles) -->
  <circle cx="575" cy="85" r="8" fill="#7b1fa2"/>
  <circle cx="595" cy="95" r="8" fill="#7b1fa2"/>
  <text x="590" y="75" font-family="Arial, sans-serif" font-size="7" fill="#4a148c">Changed</text>
  
  <!-- Unchanged features (green triangles) -->
  <polygon points="635,90 643,100 627,100" fill="#388e3c"/>
  <polygon points="655,85 663,95 647,95" fill="#388e3c"/>
  <text x="645" y="75" font-family="Arial, sans-serif" font-size="7" fill="#1b5e20">Unchanged</text>
  
  <!-- Pull arrow (between same type) -->
  <line x1="578" y1="105" x2="592" y2="115" stroke="#2e7d32" stroke-width="1.5" stroke-dasharray="3,2"/>
  <text x="575" y="130" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32">Pull</text>
  
  <!-- Push arrow (between different types) -->
  <line x1="605" y1="100" x2="625" y2="95" stroke="#c62828" stroke-width="1.5"/>
  <text x="630" y="130" font-family="Arial, sans-serif" font-size="8" fill="#c62828">Push</text>

  <!-- Loss terms for Source -->
  <text x="545" y="180" font-family="Arial, sans-serif" font-size="10" fill="#333">L</text>
  <text x="552" y="183" font-family="Arial, sans-serif" font-size="7" fill="#333">fsl</text>
  <text x="562" y="178" font-family="Arial, sans-serif" font-size="7" fill="#333">s</text>
  
  <text x="620" y="180" font-family="Arial, sans-serif" font-size="10" fill="#333">L</text>
  <text x="627" y="183" font-family="Arial, sans-serif" font-size="7" fill="#333">incl</text>
  <text x="642" y="178" font-family="Arial, sans-serif" font-size="7" fill="#333">s</text>

  <!-- ========== TARGET DOMAIN (Bottom) ========== -->
  <!-- Target Domain Label -->
  <rect x="20" y="320" width="120" height="30" rx="5" fill="#fce4ec" stroke="#c2185b" stroke-width="2"/>
  <text x="80" y="340" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#c2185b">Target Domain</text>

  <!-- Input images X1^t and X2^t -->
  <rect x="30" y="365" width="45" height="45" fill="#f8bbd9" stroke="#c2185b" stroke-width="1"/>
  <text x="52" y="392" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">X₁ᵗ</text>
  
  <rect x="85" y="365" width="45" height="45" fill="#f8bbd9" stroke="#c2185b" stroke-width="1"/>
  <text x="107" y="392" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">X₂ᵗ</text>

  <!-- Arrow from inputs to difference block -->
  <line x1="135" y1="387" x2="155" y2="387" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Get difference images block (vertical) - Target -->
  <rect x="165" y="340" width="30" height="140" rx="3" fill="#e8f5e9" stroke="#388e3c" stroke-width="1.5"/>
  <text x="180" y="380" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#2e7d32" transform="rotate(-90, 180, 410)">Get difference images</text>

  <!-- Arrow from difference to contrastive sets -->
  <line x1="200" y1="387" x2="220" y2="387" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Contrastive Support Set (Target) -->
  <rect x="230" y="345" width="80" height="35" rx="4" fill="#fff3e0" stroke="#ef6c00" stroke-width="1.5"/>
  <text x="270" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#e65100">Contrastive</text>
  <text x="270" y="370" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#e65100">Support set</text>

  <!-- Contrastive Query Set (Target) -->
  <rect x="230" y="390" width="80" height="35" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1.5"/>
  <text x="270" y="403" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#1565c0">Contrastive</text>
  <text x="270" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#1565c0">Query set</text>

  <!-- Arrows to Feature extractor -->
  <line x1="315" y1="362" x2="345" y2="387" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="315" y1="407" x2="345" y2="387" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Feature Extractor (Target - shared, same as source) -->
  <polygon points="355,360 405,387 355,415" fill="url(#extractorGrad)" stroke="#424242" stroke-width="1.5"/>
  <text x="375" y="392" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Feature</text>
  <text x="375" y="382" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">Extractor</text>

  <!-- Shared Feature Extractor indicator -->
  <line x1="380" y1="140" x2="380" y2="355" stroke="#757575" stroke-width="1" stroke-dasharray="5,3"/>
  <text x="390" y="250" font-family="Arial, sans-serif" font-size="9" fill="#616161" transform="rotate(90, 390, 250)">Shared weights</text>

  <!-- Arrows from Feature extractor to features -->
  <line x1="410" y1="375" x2="430" y2="362" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="410" y1="400" x2="430" y2="407" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Support Features (Target) -->
  <rect x="440" y="340" width="60" height="35" rx="3" fill="url(#supportGrad)" stroke="#bf360c" stroke-width="1"/>
  <text x="470" y="362" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Support</text>
  <text x="470" y="372" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">features</text>

  <!-- Query Features (Target) -->
  <rect x="440" y="385" width="60" height="35" rx="3" fill="url(#queryGrad)" stroke="#0d47a1" stroke-width="1"/>
  <text x="470" y="407" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#fff">Query</text>
  <text x="470" y="417" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#fff">features</text>

  <!-- Arrow to INSCL-T -->
  <line x1="505" y1="375" x2="535" y2="375" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- INSCL-T Block -->
  <rect x="545" y="325" width="140" height="120" rx="5" fill="#e8eaf6" stroke="#3f51b5" stroke-width="2"/>
  <text x="615" y="342" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1a237e">INSCL-T</text>
  
  <!-- Changed features (purple circles) -->
  <circle cx="575" cy="365" r="8" fill="#7b1fa2"/>
  <circle cx="595" cy="375" r="8" fill="#7b1fa2"/>
  <text x="590" y="355" font-family="Arial, sans-serif" font-size="7" fill="#4a148c">Changed</text>
  
  <!-- Unchanged features (green triangles) -->
  <polygon points="635,370 643,380 627,380" fill="#388e3c"/>
  <polygon points="655,365 663,375 647,375" fill="#388e3c"/>
  <text x="645" y="355" font-family="Arial, sans-serif" font-size="7" fill="#1b5e20">Unchanged</text>
  
  <!-- Pull arrow (between same type) -->
  <line x1="578" y1="385" x2="592" y2="395" stroke="#2e7d32" stroke-width="1.5" stroke-dasharray="3,2"/>
  <text x="575" y="410" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32">Pull</text>
  
  <!-- Push arrow (between different types) -->
  <line x1="605" y1="380" x2="625" y2="375" stroke="#c62828" stroke-width="1.5"/>
  <text x="630" y="410" font-family="Arial, sans-serif" font-size="8" fill="#c62828">Push</text>

  <!-- Loss terms for Target -->
  <text x="545" y="460" font-family="Arial, sans-serif" font-size="10" fill="#333">L</text>
  <text x="552" y="463" font-family="Arial, sans-serif" font-size="7" fill="#333">fsl</text>
  <text x="562" y="458" font-family="Arial, sans-serif" font-size="7" fill="#333">t</text>
  
  <text x="620" y="460" font-family="Arial, sans-serif" font-size="10" fill="#333">L</text>
  <text x="627" y="463" font-family="Arial, sans-serif" font-size="7" fill="#333">incl</text>
  <text x="642" y="458" font-family="Arial, sans-serif" font-size="7" fill="#333">t</text>

  <!-- ========== CRCA Block (Right Side) ========== -->
  <rect x="730" y="100" width="200" height="300" rx="8" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2"/>
  <text x="830" y="125" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#4a148c">CRCA</text>

  <!-- Arrow from INSCL-S to CRCA -->
  <line x1="690" y1="105" x2="720" y2="160" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Arrow from INSCL-T to CRCA -->
  <line x1="690" y1="385" x2="720" y2="340" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Source Features in CRCA -->
  <rect x="750" y="145" width="160" height="70" rx="4" fill="#e3f2fd" stroke="#1976d2" stroke-width="1.5"/>
  <text x="830" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1565c0">Source features</text>
  
  <!-- Feature representations (circles and triangles) -->
  <circle cx="770" cy="190" r="6" fill="#7b1fa2"/>
  <circle cx="790" cy="185" r="6" fill="#7b1fa2"/>
  <circle cx="810" cy="192" r="6" fill="#7b1fa2"/>
  <polygon points="840,187 848,197 832,197" fill="#388e3c"/>
  <polygon points="865,185 873,195 857,195" fill="#388e3c"/>
  <polygon points="890,190 898,200 882,200" fill="#388e3c"/>

  <!-- Target Features in CRCA -->
  <rect x="750" y="285" width="160" height="70" rx="4" fill="#fce4ec" stroke="#c2185b" stroke-width="1.5"/>
  <text x="830" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#c2185b">Target features</text>
  
  <!-- Feature representations (circles and triangles) -->
  <circle cx="770" cy="330" r="6" fill="#7b1fa2"/>
  <circle cx="790" cy="325" r="6" fill="#7b1fa2"/>
  <circle cx="810" cy="332" r="6" fill="#7b1fa2"/>
  <polygon points="840,327 848,337 832,337" fill="#388e3c"/>
  <polygon points="865,325 873,335 857,335" fill="#388e3c"/>
  <polygon points="890,330 898,340 882,340" fill="#388e3c"/>

  <!-- Align arrows between Source and Target -->
  <line x1="780" y1="220" x2="780" y2="275" stroke="#1565c0" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  <line x1="810" y1="220" x2="810" y2="275" stroke="#1565c0" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  <line x1="860" y1="220" x2="860" y2="275" stroke="#1565c0" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  <line x1="890" y1="220" x2="890" y2="275" stroke="#1565c0" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  
  <text x="830" y="255" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#1565c0">Align</text>

  <!-- Legend in CRCA -->
  <rect x="755" y="365" width="150" height="30" rx="3" fill="#fff" stroke="#9e9e9e" stroke-width="1"/>
  <circle cx="775" cy="380" r="5" fill="#7b1fa2"/>
  <text x="790" y="383" font-family="Arial, sans-serif" font-size="8" fill="#333">Changed</text>
  <polygon points="845,377 851,385 839,385" fill="#388e3c"/>
  <text x="865" y="383" font-family="Arial, sans-serif" font-size="8" fill="#333">Unchanged</text>

  <!-- Arrow to L_crca -->
  <line x1="830" y1="405" x2="830" y2="440" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- L_crca loss term -->
  <rect x="800" y="450" width="60" height="30" rx="4" fill="#fff" stroke="#333" stroke-width="1.5"/>
  <text x="815" y="470" font-family="Arial, sans-serif" font-size="12" fill="#333">L</text>
  <text x="825" y="473" font-family="Arial, sans-serif" font-size="8" fill="#333">crca</text>

  <!-- ========== Overall Flow Arrows ========== -->
  <!-- Connecting lines showing data flow -->
  
  <!-- Title -->
  <text x="600" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#333">Model Architecture: Cross-Scene Few-Shot Learning with Contrastive Alignment</text>

  <!-- Loss aggregation arrows -->
  <line x1="560" y1="185" x2="560" y2="500" stroke="#333" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="635" y1="185" x2="635" y2="500" stroke="#333" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="560" y1="465" x2="560" y2="500" stroke="#333" stroke-width="1" stroke-dasharray="4,2"/>
  <line x1="635" y1="465" x2="635" y2="500" stroke="#333" stroke-width="1" stroke-dasharray="4,2"/>
  
  <!-- Total Loss -->
  <rect x="520" y="510" width="180" height="35" rx="5" fill="#ffecb3" stroke="#ff8f00" stroke-width="2"/>
  <text x="610" y="533" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">Total Loss = L_fsl + L_incl + L_crca</text>

  <!-- Arrow from L_crca to Total Loss -->
  <line x1="830" y1="485" x2="830" y2="527" stroke="#333" stroke-width="1.5"/>
  <line x1="830" y1="527" x2="705" y2="527" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
</svg>
